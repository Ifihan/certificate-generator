<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: #fafafa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #1a1a1a;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 20px 40px rgba(0,0,0,0.04);
            padding: 48px;
            max-width: 680px;
            width: 100%;
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 32px;
            font-size: 0.9375rem;
            font-weight: 400;
        }

        .info-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            line-height: 1.65;
            font-size: 0.875rem;
            color: #4b5563;
        }

        .info-box strong {
            color: #1a1a1a;
            font-weight: 600;
        }

        .upload-section {
            background: #fafafa;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #9ca3af;
            background: #f5f5f5;
        }

        input[type="file"] { display: none; }

        .upload-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #1a1a1a;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .upload-label:hover {
            background: #2d2d2d;
            transform: translateY(-1px);
        }

        .upload-label:active {
            transform: translateY(0);
        }

        .file-info {
            margin-top: 16px;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .btn {
            border: none;
            padding: 14px 24px;
            font-size: 0.9375rem;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2d2d2d;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #059669;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #047857;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: white;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .btn-warning:hover:not(:disabled) {
            background: #fef2f2;
            border-color: #f87171;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        .status {
            margin-top: 24px;
            padding: 16px 20px;
            border-radius: 10px;
            display: none;
            font-size: 0.9375rem;
            line-height: 1.5;
        }

        .status.show { display: block; }

        .status.loading {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .status.success {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status.warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .results {
            margin-top: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .results::-webkit-scrollbar {
            width: 8px;
        }

        .results::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 4px;
        }

        .results::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .results::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .result-item {
            background: #fafafa;
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            border-left: 3px solid #1a1a1a;
            transition: all 0.2s ease;
        }

        .result-item:hover {
            background: #f5f5f5;
        }

        .result-item.error {
            border-left-color: #dc2626;
            background: #fef2f2;
        }

        .result-item.error:hover {
            background: #fee2e2;
        }

        .result-name {
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 6px;
            font-size: 0.9375rem;
        }

        .result-url {
            font-size: 0.8125rem;
            color: #6b7280;
            word-break: break-all;
        }

        .result-url a {
            color: #2563eb;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .result-url a:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }

        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #1a1a1a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none; }

        .progress-info {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
            color: #92400e;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .progress-info strong {
            color: #78350f;
            font-weight: 600;
        }

        /* Icon styles */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Certificate Generator</h1>
        <p class="subtitle">Generate and distribute certificates with ease</p>

        <div class="info-box">
            <strong>How it works</strong><br>
            1. Upload CSV with 'name' column<br>
            2. Click "Generate Certificates"<br>
            3. Download CSV with certificate links<br>
            4. If interrupted, click "Continue" to resume
        </div>

        <div id="progressInfo" class="progress-info hidden">
            <strong>Previous session detected</strong><br>
            You have <span id="progressCount">0</span> certificates already generated.<br>
            Click "Continue" to resume or upload new CSV to start fresh.
        </div>

        <div class="upload-section" onclick="document.getElementById('csvFile').click()">
            <input type="file" id="csvFile" accept=".csv" onchange="handleFileSelect(event)">
            <label for="csvFile" class="upload-label">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                </svg>
                Choose CSV File
            </label>
            <div id="fileInfo" class="file-info">No file selected</div>
        </div>

        <div id="btnGroup" class="btn-group hidden">
            <button class="btn btn-primary" id="generateBtn" onclick="generateCertificates()">Generate Certificates</button>
            <button class="btn btn-secondary hidden" id="continueBtn" onclick="generateCertificates()">Continue</button>
        </div>

        <button class="btn btn-warning hidden" id="resetBtn" onclick="resetProgress()">Start Fresh</button>

        <div class="status" id="status"></div>
        <div class="results" id="results"></div>
    </div>

    <script>
        let uploadedFile = false, hasProgress = false;

        async function checkExistingProgress() {
            try {
                const {has_progress, processed_count, results} = await (await fetch('/check-progress')).json();
                if (has_progress) {
                    hasProgress = true;
                    document.getElementById('progressInfo').classList.remove('hidden');
                    document.getElementById('progressCount').textContent = processed_count;
                    document.getElementById('continueBtn').classList.remove('hidden');
                    document.getElementById('resetBtn').classList.remove('hidden');
                    document.getElementById('btnGroup').classList.remove('hidden');
                    if (results?.length) displayResults(results, false);
                }
            } catch (e) { console.error('Progress check failed:', e); }
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            document.getElementById('fileInfo').textContent = `Selected: ${file.name}`;
            status.className = 'status show loading';
            status.innerHTML = '<div class="spinner"></div>Uploading and validating...';

            try {
                const formData = new FormData();
                formData.append('file', file);
                const data = await (await fetch('/upload-csv', {method: 'POST', body: formData})).json();

                if (data.success) {
                    uploadedFile = true;
                    if (data.is_new_csv) {
                        status.className = 'status show warning';
                        status.innerHTML = `<strong>New CSV detected</strong><br>
                            ${data.previous_progress} certificates from previous CSV.<br>
                            Click "Start Fresh" to use this new CSV.`;
                        document.getElementById('resetBtn').classList.remove('hidden');
                        document.getElementById('generateBtn').disabled = true;
                    } else {
                        status.className = 'status show success';
                        status.innerHTML = `✓ ${data.message}`;
                        document.getElementById('btnGroup').classList.remove('hidden');
                        document.getElementById('generateBtn').disabled = false;
                        if (hasProgress) document.getElementById('continueBtn').classList.remove('hidden');
                    }
                } else {
                    status.className = 'status show error';
                    status.innerHTML = `<strong>Error:</strong> ${data.error}`;
                }
            } catch (e) {
                status.className = 'status show error';
                status.innerHTML = `<strong>Error:</strong> ${e.message}`;
            }
        }

        async function generateCertificates() {
            if (!uploadedFile && !hasProgress) return alert('Please upload a CSV file first');

            const generateBtn = document.getElementById('generateBtn');
            const continueBtn = document.getElementById('continueBtn');
            const status = document.getElementById('status');

            generateBtn.disabled = continueBtn.disabled = true;
            status.className = 'status show loading';
            status.innerHTML = '<div class="spinner"></div>Generating certificates... Progress saved automatically.';

            try {
                const data = await (await fetch('/generate', {method: 'POST'})).json();
                if (data.success) {
                    status.className = 'status show success';
                    status.innerHTML = `<strong>Success!</strong> Generated ${data.results.length} certificates.`;
                    displayResults(data.results, true);
                    if (data.completed) {
                        document.getElementById('continueBtn').classList.add('hidden');
                        document.getElementById('progressInfo').classList.add('hidden');
                    }
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                status.className = 'status show error';
                status.innerHTML = `<strong>Error:</strong> ${e.message}`;
            } finally {
                generateBtn.disabled = continueBtn.disabled = false;
            }
        }

        function displayResults(results, showDownload) {
            const html = results.map(r => `
                <div class="result-item ${r.status === 'error' ? 'error' : ''}">
                    <div class="result-name">${r.name}</div>
                    <div class="result-url">
                        ${r.status === 'error'
                            ? `<span style="color:#dc2626">Error: ${r.error || 'Unknown'}</span>`
                            : `<a href="${r.url}" target="_blank">${r.url}</a>`
                        }
                    </div>
                </div>
            `).join('') + (showDownload ? '<button class="btn btn-secondary" onclick="downloadCSV()" style="margin-top:16px">Download CSV</button>' : '');
            document.getElementById('results').innerHTML = html;
        }

        async function resetProgress() {
            if (!confirm('Reset all progress?')) return;
            const status = document.getElementById('status');
            status.className = 'status show loading';
            status.innerHTML = '<div class="spinner"></div>Resetting...';

            try {
                const data = await (await fetch('/reset-progress', {method: 'POST'})).json();
                if (data.success) {
                    status.className = 'status show success';
                    status.innerHTML = '✓ Progress reset. Upload new CSV.';
                    document.getElementById('progressInfo').classList.add('hidden');
                    document.getElementById('continueBtn').classList.add('hidden');
                    document.getElementById('results').innerHTML = '';
                    hasProgress = false;
                    if (uploadedFile) document.getElementById('generateBtn').disabled = false;
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                status.className = 'status show error';
                status.innerHTML = `<strong>Error:</strong> ${e.message}`;
            }
        }

        function downloadCSV() { window.location.href = '/download-csv'; }

        window.addEventListener('DOMContentLoaded', checkExistingProgress);
    </script>
</body>
</html>
